version: '3.9'

services:
  # PostgreSQL - Primary database
  postgres:
    image: postgres:15-alpine
    container_name: nivo-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-nivo}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-nivo_dev_password}
      POSTGRES_DB: ${POSTGRES_DB:-nivo}
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-nivo}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - nivo-network

  # Redis - Caching and session storage
  redis:
    image: redis:7-alpine
    container_name: nivo-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-nivo_redis_password}
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - nivo-network

  # NSQ Lookup - Service discovery for NSQ
  nsqlookupd:
    image: nsqio/nsq:v1.2.1
    container_name: nivo-nsqlookupd
    restart: unless-stopped
    command: /nsqlookupd
    ports:
      - "${NSQLOOKUPD_TCP_PORT:-4160}:4160"
      - "${NSQLOOKUPD_HTTP_PORT:-4161}:4161"
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O - http://localhost:4161/ping || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - nivo-network

  # NSQ Daemon - Message queue daemon
  nsqd:
    image: nsqio/nsq:v1.2.1
    container_name: nivo-nsqd
    restart: unless-stopped
    command: /nsqd --lookupd-tcp-address=nsqlookupd:4160 --broadcast-address=nsqd
    depends_on:
      - nsqlookupd
    ports:
      - "${NSQD_TCP_PORT:-4150}:4150"
      - "${NSQD_HTTP_PORT:-4151}:4151"
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O - http://localhost:4151/ping || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - nivo-network

  # NSQ Admin - Web UI for NSQ
  nsqadmin:
    image: nsqio/nsq:v1.2.1
    container_name: nivo-nsqadmin
    restart: unless-stopped
    command: /nsqadmin --lookupd-http-address=nsqlookupd:4161
    depends_on:
      - nsqlookupd
    ports:
      - "${NSQADMIN_PORT:-4171}:4171"
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O - http://localhost:4171/ping || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - nivo-network

  # Prometheus - Metrics collection (for future observability)
  prometheus:
    image: prom/prometheus:v2.45.0
    container_name: nivo-prometheus
    restart: unless-stopped
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"
    volumes:
      - ./scripts/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O - http://localhost:9090/-/healthy || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - nivo-network

  # Grafana - Metrics visualization and dashboards
  grafana:
    image: grafana/grafana:10.2.0
    container_name: nivo-grafana
    restart: unless-stopped
    ports:
      - "${GRAFANA_PORT:-3000}:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=http://localhost:3000
      - GF_INSTALL_PLUGINS=
    volumes:
      - grafana_data:/var/lib/grafana
      - ./scripts/grafana/provisioning:/etc/grafana/provisioning:ro
    depends_on:
      prometheus:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O - http://localhost:3000/api/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - nivo-network

  # Identity Service - Authentication and KYC
  identity-service:
    build:
      context: .
      dockerfile: services/identity/Dockerfile
    container_name: nivo-identity
    restart: unless-stopped
    environment:
      SERVICE_PORT: 8080
      ENVIRONMENT: development
      DATABASE_URL: postgres://${POSTGRES_USER:-nivo}:${POSTGRES_PASSWORD:-nivo_dev_password}@postgres:5432/${POSTGRES_DB:-nivo}?sslmode=disable
      MIGRATIONS_DIR: ./migrations
      JWT_SECRET: ${JWT_SECRET:-your-super-secret-jwt-key-change-in-production}
      JWT_EXPIRY_HOURS: ${JWT_EXPIRY_HOURS:-24}
      TIMEZONE: Asia/Kolkata
      DEFAULT_CURRENCY: INR
      COUNTRY_CODE: IN
    ports:
      - "${IDENTITY_PORT:-8080}:8080"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - nivo-network
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O - http://localhost:8080/health || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 5

  # Ledger Service - Double-entry bookkeeping
  ledger-service:
    build:
      context: .
      dockerfile: services/ledger/Dockerfile
    container_name: nivo-ledger
    restart: unless-stopped
    environment:
      SERVICE_PORT: 8081
      ENVIRONMENT: development
      DATABASE_URL: postgres://${POSTGRES_USER:-nivo}:${POSTGRES_PASSWORD:-nivo_dev_password}@postgres:5432/${POSTGRES_DB:-nivo}?sslmode=disable
      MIGRATIONS_DIR: ./migrations
      JWT_SECRET: ${JWT_SECRET:-your-super-secret-jwt-key-change-in-production}
      TIMEZONE: Asia/Kolkata
      DEFAULT_CURRENCY: INR
      COUNTRY_CODE: IN
    ports:
      - "${LEDGER_PORT:-8081}:8081"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - nivo-network
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O - http://localhost:8081/health || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 5

  # RBAC Service - Role-Based Access Control
  rbac-service:
    build:
      context: .
      dockerfile: services/rbac/Dockerfile
    container_name: nivo-rbac
    restart: unless-stopped
    environment:
      SERVICE_PORT: 8082
      ENVIRONMENT: development
      DATABASE_URL: postgres://${POSTGRES_USER:-nivo}:${POSTGRES_PASSWORD:-nivo_dev_password}@postgres:5432/${POSTGRES_DB:-nivo}?sslmode=disable
      MIGRATIONS_DIR: ./migrations
      JWT_SECRET: ${JWT_SECRET:-your-super-secret-jwt-key-change-in-production}
      TIMEZONE: Asia/Kolkata
      DEFAULT_CURRENCY: INR
      COUNTRY_CODE: IN
    ports:
      - "${RBAC_PORT:-8082}:8082"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - nivo-network
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O - http://localhost:8082/health || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 5

  # Wallet Service - User wallet management
  wallet-service:
    build:
      context: .
      dockerfile: services/wallet/Dockerfile
    container_name: nivo-wallet
    restart: unless-stopped
    environment:
      SERVICE_PORT: 8083
      ENVIRONMENT: development
      DATABASE_URL: postgres://${POSTGRES_USER:-nivo}:${POSTGRES_PASSWORD:-nivo_dev_password}@postgres:5432/${POSTGRES_DB:-nivo}?sslmode=disable
      MIGRATIONS_DIR: ./migrations
      JWT_SECRET: ${JWT_SECRET:-your-super-secret-jwt-key-change-in-production}
      TIMEZONE: Asia/Kolkata
      DEFAULT_CURRENCY: INR
      COUNTRY_CODE: IN
    ports:
      - "${WALLET_PORT:-8083}:8083"
    depends_on:
      postgres:
        condition: service_healthy
      ledger-service:
        condition: service_healthy
    networks:
      - nivo-network
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O - http://localhost:8083/health || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 5

  # Transaction Service - Money transfers and transactions
  transaction-service:
    build:
      context: .
      dockerfile: services/transaction/Dockerfile
    container_name: nivo-transaction
    restart: unless-stopped
    environment:
      SERVICE_PORT: 8084
      ENVIRONMENT: development
      DATABASE_URL: postgres://${POSTGRES_USER:-nivo}:${POSTGRES_PASSWORD:-nivo_dev_password}@postgres:5432/${POSTGRES_DB:-nivo}?sslmode=disable
      MIGRATIONS_DIR: ./migrations
      JWT_SECRET: ${JWT_SECRET:-your-super-secret-jwt-key-change-in-production}
      RISK_SERVICE_URL: http://risk-service:8085
      TIMEZONE: Asia/Kolkata
      DEFAULT_CURRENCY: INR
      COUNTRY_CODE: IN
    ports:
      - "${TRANSACTION_PORT:-8084}:8084"
    depends_on:
      postgres:
        condition: service_healthy
      wallet-service:
        condition: service_healthy
      ledger-service:
        condition: service_healthy
      risk-service:
        condition: service_healthy
    networks:
      - nivo-network
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O - http://localhost:8084/health || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 5

  # Risk Service - Risk evaluation and fraud detection
  risk-service:
    build:
      context: .
      dockerfile: services/risk/Dockerfile
    container_name: nivo-risk
    restart: unless-stopped
    environment:
      SERVICE_PORT: 8085
      ENVIRONMENT: development
      DATABASE_URL: postgres://${POSTGRES_USER:-nivo}:${POSTGRES_PASSWORD:-nivo_dev_password}@postgres:5432/${POSTGRES_DB:-nivo}?sslmode=disable
      MIGRATIONS_DIR: ./migrations
      TIMEZONE: Asia/Kolkata
      DEFAULT_CURRENCY: INR
      COUNTRY_CODE: IN
    ports:
      - "${RISK_PORT:-8085}:8085"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - nivo-network
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O - http://localhost:8085/health || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 5

  # API Gateway - Unified entry point for all services
  gateway:
    build:
      context: .
      dockerfile: gateway/Dockerfile
    container_name: nivo-gateway
    restart: unless-stopped
    environment:
      SERVICE_PORT: 8000
      ENVIRONMENT: development
      JWT_SECRET: ${JWT_SECRET:-your-super-secret-jwt-key-change-in-production}
      # Backend service URLs (internal docker network)
      IDENTITY_SERVICE_URL: http://identity-service:8080
      LEDGER_SERVICE_URL: http://ledger-service:8081
      RBAC_SERVICE_URL: http://rbac-service:8082
      WALLET_SERVICE_URL: http://wallet-service:8083
      TRANSACTION_SERVICE_URL: http://transaction-service:8084
      RISK_SERVICE_URL: http://risk-service:8085
    ports:
      - "${GATEWAY_PORT:-8000}:8000"
    depends_on:
      identity-service:
        condition: service_healthy
      ledger-service:
        condition: service_healthy
      rbac-service:
        condition: service_healthy
      wallet-service:
        condition: service_healthy
      transaction-service:
        condition: service_healthy
    networks:
      - nivo-network
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O - http://localhost:8000/health || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 5

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  prometheus_data:
    driver: local
  grafana_data:
    driver: local

networks:
  nivo-network:
    driver: bridge
