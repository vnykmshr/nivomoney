<!-- Favicon - Nivo brand blue -->
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%233b82f6'/><text x='50' y='68' font-size='50' font-weight='bold' fill='white' text-anchor='middle' font-family='system-ui'>N</text></svg>">

<!-- CRITICAL: Apply theme BEFORE page renders to prevent flash -->
<script>
(function() {
  // Determine theme: localStorage > system preference > default (nivo)
  var saved = localStorage.getItem('nivo-theme');
  var theme = saved || (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'nivo-dark' : 'nivo');
  document.documentElement.setAttribute('data-theme', theme);
})();
</script>

<style>
  /* ========================================
     STICKY HEADER (mobile only - sidebar handles desktop)
     ======================================== */
  @media (max-width: 799px) {
    .site-header {
      position: sticky;
      top: 0;
      z-index: 100;
      background-color: #ffffff;
    }

    [data-theme="nivo-dark"] .site-header {
      background-color: #0f172a;
    }
  }

  /* ========================================
     THEME TOGGLE BUTTON
     ======================================== */
  .aux-nav-item {
    display: flex;
    align-items: center;
  }

  .theme-toggle-header {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.5rem;
    border: 1px solid #3b82f6;
    border-radius: 0.5rem;
    background: transparent;
    color: #3b82f6;
    cursor: pointer;
    transition: all 0.2s;
    margin-left: 0.75rem;
  }

  .theme-toggle-header:hover {
    background-color: #eff6ff;
  }

  .theme-toggle-header svg {
    width: 1.25rem;
    height: 1.25rem;
  }

  [data-theme="nivo-dark"] .theme-toggle-header {
    color: #60a5fa;
    border-color: #60a5fa;
  }

  [data-theme="nivo-dark"] .theme-toggle-header:hover {
    background-color: rgba(96, 165, 250, 0.1);
  }

  .theme-toggle-header .sun-icon { display: none; }
  .theme-toggle-header .moon-icon { display: block; }

  [data-theme="nivo-dark"] .theme-toggle-header .sun-icon { display: block; }
  [data-theme="nivo-dark"] .theme-toggle-header .moon-icon { display: none; }

  /* ========================================
     MERMAID DIAGRAMS
     ======================================== */
  .mermaid {
    background: #f8fafc !important;
    border: 1px solid #e2e8f0;
    border-radius: 0.75rem;
    padding: 1.5rem;
    margin: 1.5rem 0;
    overflow-x: auto;
  }

  [data-theme="nivo-dark"] .mermaid {
    background: #1e293b !important;
    border-color: #475569;
  }

  /* Mermaid text colors */
  .mermaid text,
  .mermaid .nodeLabel,
  .mermaid .edgeLabel,
  .mermaid .label {
    fill: #0f172a !important;
    color: #0f172a !important;
  }

  [data-theme="nivo-dark"] .mermaid text,
  [data-theme="nivo-dark"] .mermaid .nodeLabel,
  [data-theme="nivo-dark"] .mermaid .edgeLabel,
  [data-theme="nivo-dark"] .mermaid .label {
    fill: #f1f5f9 !important;
    color: #f1f5f9 !important;
  }

  /* Mermaid node backgrounds */
  .mermaid .node rect,
  .mermaid .node circle,
  .mermaid .node polygon {
    fill: #dbeafe !important;
    stroke: #3b82f6 !important;
  }

  [data-theme="nivo-dark"] .mermaid .node rect,
  [data-theme="nivo-dark"] .mermaid .node circle,
  [data-theme="nivo-dark"] .mermaid .node polygon {
    fill: #1e3a8a !important;
    stroke: #60a5fa !important;
  }

  /* Mermaid clusters/subgraphs */
  .mermaid .cluster rect {
    fill: #f1f5f9 !important;
    stroke: #cbd5e1 !important;
  }

  [data-theme="nivo-dark"] .mermaid .cluster rect {
    fill: #0f172a !important;
    stroke: #475569 !important;
  }

  .mermaid .cluster .nodeLabel {
    fill: #334155 !important;
  }

  [data-theme="nivo-dark"] .mermaid .cluster .nodeLabel {
    fill: #94a3b8 !important;
  }

  /* Mermaid edge lines */
  .mermaid .edgePath .path {
    stroke: #64748b !important;
  }

  [data-theme="nivo-dark"] .mermaid .edgePath .path {
    stroke: #94a3b8 !important;
  }

  /* ========================================
     TABLE STYLING - EXPLICIT BACKGROUNDS
     ======================================== */
  .main-content table {
    border: 1px solid #e2e8f0;
    border-radius: 0.5rem;
    overflow: hidden;
    margin: 1.5rem 0;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    background-color: #ffffff;
  }

  .main-content table thead {
    background-color: #f8fafc;
  }

  .main-content table th {
    background: linear-gradient(to bottom, #f8fafc, #f1f5f9);
    color: #0f172a;
    font-weight: 600;
    padding: 0.875rem 1rem;
    border-bottom: 2px solid #e2e8f0;
  }

  .main-content table tbody {
    background-color: #ffffff;
  }

  .main-content table tr {
    background-color: #ffffff;
  }

  .main-content table tr:nth-child(even) {
    background-color: #f8fafc;
  }

  .main-content table td {
    padding: 0.75rem 1rem;
    color: #334155;
    border-bottom: 1px solid #f1f5f9;
    background-color: inherit;
  }

  .main-content table tr:last-child td {
    border-bottom: none;
  }

  .main-content table tr:hover {
    background-color: #eff6ff;
  }

  /* Dark mode table styling - EXPLICIT backgrounds to override any inherited white */
  [data-theme="nivo-dark"] .main-content table {
    border-color: #334155;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    background-color: #111827;
  }

  [data-theme="nivo-dark"] .main-content table thead {
    background-color: #1e293b;
  }

  [data-theme="nivo-dark"] .main-content table th {
    background: linear-gradient(to bottom, #1e293b, #0f172a);
    color: #f1f5f9;
    border-bottom-color: #334155;
  }

  [data-theme="nivo-dark"] .main-content table tbody {
    background-color: #111827;
  }

  [data-theme="nivo-dark"] .main-content table tr {
    background-color: #111827;
  }

  [data-theme="nivo-dark"] .main-content table tr:nth-child(even) {
    background-color: #1e293b;
  }

  [data-theme="nivo-dark"] .main-content table td {
    color: #cbd5e1;
    border-bottom-color: #1e293b;
    background-color: inherit;
  }

  [data-theme="nivo-dark"] .main-content table tr:hover {
    background-color: #1e3a8a;
  }

  .main-content table strong {
    color: #0f172a;
    font-weight: 600;
  }

  [data-theme="nivo-dark"] .main-content table strong {
    color: #f1f5f9;
  }

  /* Table links */
  .main-content table a {
    color: #2563eb;
  }

  [data-theme="nivo-dark"] .main-content table a {
    color: #60a5fa;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Inject theme toggle button into header
  var auxNav = document.querySelector('.aux-nav ul') || document.querySelector('.aux-nav');
  if (!auxNav) return;

  var toggleItem = document.createElement('li');
  toggleItem.className = 'aux-nav-item';

  var button = document.createElement('button');
  button.className = 'theme-toggle-header';
  button.setAttribute('aria-label', 'Toggle dark mode');
  button.setAttribute('title', 'Toggle theme');
  button.setAttribute('type', 'button');

  // Sun icon (shown in dark mode)
  button.innerHTML = '<svg class="sun-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg>' +
    '<svg class="moon-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>';

  button.addEventListener('click', function() {
    var html = document.documentElement;
    var current = html.getAttribute('data-theme') || 'nivo';
    var next = current === 'nivo-dark' ? 'nivo' : 'nivo-dark';

    html.setAttribute('data-theme', next);
    localStorage.setItem('nivo-theme', next);

    // Sync with Just the Docs if available
    if (typeof jtd !== 'undefined' && typeof jtd.setTheme === 'function') {
      jtd.setTheme(next);
    }

    // Re-render Mermaid diagrams with new theme
    if (typeof mermaid !== 'undefined') {
      reinitMermaid(next === 'nivo-dark');
    }
  });

  toggleItem.appendChild(button);
  auxNav.appendChild(toggleItem);

  // Sync initial theme with jtd
  var theme = document.documentElement.getAttribute('data-theme');
  if (typeof jtd !== 'undefined' && typeof jtd.setTheme === 'function') {
    jtd.setTheme(theme);
  }
});

// Mermaid theme configuration
function getMermaidConfig(isDark) {
  return {
    startOnLoad: false,
    theme: 'base',
    themeVariables: isDark ? {
      // Dark theme colors
      primaryColor: '#1e3a8a',
      primaryTextColor: '#f1f5f9',
      primaryBorderColor: '#60a5fa',
      lineColor: '#94a3b8',
      secondaryColor: '#334155',
      tertiaryColor: '#1e293b',
      background: '#1e293b',
      mainBkg: '#1e3a8a',
      nodeBorder: '#60a5fa',
      clusterBkg: '#0f172a',
      clusterBorder: '#475569',
      titleColor: '#f1f5f9',
      edgeLabelBackground: '#1e293b',
      textColor: '#f1f5f9',
      nodeTextColor: '#f1f5f9',
      labelTextColor: '#f1f5f9',
      actorTextColor: '#f1f5f9',
      actorBkg: '#1e3a8a',
      actorBorder: '#60a5fa',
      signalColor: '#94a3b8',
      signalTextColor: '#f1f5f9',
      labelBoxBkgColor: '#1e293b',
      labelBoxBorderColor: '#475569',
      noteBkgColor: '#334155',
      noteBorderColor: '#475569',
      noteTextColor: '#f1f5f9',
      activationBkgColor: '#1e3a8a',
      activationBorderColor: '#60a5fa'
    } : {
      // Light theme colors
      primaryColor: '#dbeafe',
      primaryTextColor: '#0f172a',
      primaryBorderColor: '#3b82f6',
      lineColor: '#64748b',
      secondaryColor: '#f1f5f9',
      tertiaryColor: '#e2e8f0',
      background: '#f8fafc',
      mainBkg: '#dbeafe',
      nodeBorder: '#3b82f6',
      clusterBkg: '#f1f5f9',
      clusterBorder: '#cbd5e1',
      titleColor: '#0f172a',
      edgeLabelBackground: '#ffffff',
      textColor: '#0f172a',
      nodeTextColor: '#0f172a',
      labelTextColor: '#0f172a',
      actorTextColor: '#0f172a',
      actorBkg: '#dbeafe',
      actorBorder: '#3b82f6',
      signalColor: '#64748b',
      signalTextColor: '#0f172a',
      labelBoxBkgColor: '#ffffff',
      labelBoxBorderColor: '#cbd5e1',
      noteBkgColor: '#eff6ff',
      noteBorderColor: '#3b82f6',
      noteTextColor: '#0f172a',
      activationBkgColor: '#dbeafe',
      activationBorderColor: '#3b82f6'
    }
  };
}

// Mermaid re-initialization for theme changes
function reinitMermaid(isDark) {
  if (typeof mermaid === 'undefined') return;

  mermaid.initialize(getMermaidConfig(isDark));

  // Re-render all mermaid diagrams
  document.querySelectorAll('.mermaid').forEach(function(el) {
    var code = el.getAttribute('data-original-code');
    if (code) {
      el.removeAttribute('data-processed');
      el.innerHTML = code;
    }
  });

  mermaid.run();
}

// Store original mermaid code when page loads
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.mermaid').forEach(function(el) {
    if (!el.getAttribute('data-original-code')) {
      el.setAttribute('data-original-code', el.textContent.trim());
    }
  });

  // Initialize mermaid with current theme
  var isDark = document.documentElement.getAttribute('data-theme') === 'nivo-dark';
  if (typeof mermaid !== 'undefined') {
    reinitMermaid(isDark);
  }
});

// Listen for system theme changes (only if no saved preference)
if (window.matchMedia) {
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
    if (!localStorage.getItem('nivo-theme')) {
      var theme = e.matches ? 'nivo-dark' : 'nivo';
      document.documentElement.setAttribute('data-theme', theme);
      if (typeof jtd !== 'undefined') jtd.setTheme(theme);
      if (typeof mermaid !== 'undefined') reinitMermaid(e.matches);
    }
  });
}
</script>
